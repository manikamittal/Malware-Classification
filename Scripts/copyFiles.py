import os,sys,csv
import shutil
from collections import Counter

# get class labels from csv file
def getClassLabels():
    reader = csv.reader(open(conf['script']['labels'],'rb'))
    trainLabels = {}

    for row in reader:
        key = row[0]
        if key in trainLabels:
            pass
        trainLabels[key] = row[1]
    del trainLabels['Id']
    return trainLabels

# count occurrence of various classes
def countOfFiles(trainLabels):
    return dict(Counter(trainLabels.values()))

# half file count to separate training and testing evenly
def copyNFiles(fileCount, env):
    for keys in fileCount.keys():
        if fileCount[keys] > env * 2:
            fileCount[keys] = env * 2

    return fileCount

# get list of file names for training and testing data
def getTrainingFilesName(labels, fileCount):
    trainLabels = []
    testLabels = []
    tempFileCount = fileCount.copy()
    for keys in labels.keys():
        fileClass = labels[keys]
        if fileCount[fileClass] > tempFileCount[fileClass] / 2:
            trainLabels.append(keys)
            fileCount[fileClass] -= 1
        elif (fileCount[fileClass] > 0) and (fileCount[fileClass] <= tempFileCount[fileClass] / 2):
            testLabels.append(keys)
            fileCount[fileClass] -= 1
        else:
            pass

    return trainLabels,testLabels

# output train & test file names
def outputCSV(trainLabels, testLabels):
    trainFile = open(conf['train']['file_names'], 'w+')
    testFile = open(conf['test']['file_names'], 'w+')

    tr = csv.writer(trainFile, quoting=csv.QUOTE_ALL)
    te = csv.writer(testFile, quoting=csv.QUOTE_ALL)

    tr.writerow(trainLabels)
    te.writerow(testLabels)

# create train & test labels
def createLabelsCSV(labels, trainLabels, testLabels):
    trainLabelsLoc = open(conf['test']['labels'], 'w+')
    testLabelsLoc = open(conf['train']['labels'], 'w+')

    tr = csv.DictWriter(trainLabelsLoc, fieldnames=['Id','Class'])
    tr.writeheader()

    te = csv.DictWriter(testLabelsLoc, fieldnames=['Id','Class'])
    te.writeheader()

    for value in trainLabels:
        entry = dict({'Id':value, 'Class':labels[value]})
        te.writerow(entry)

    for value in testLabels:
        entry = dict({'Id':value, 'Class':labels[value]})
        tr.writerow(entry)

def makeDataFolders():
    if not os.path.exists(conf['train']['file_loc']):
        os.makedirs(conf['train']['file_loc'])

    if not os.path.exists(conf['test']['file_loc']):
        os.makedirs(conf['test']['file_loc'])

# copy files from the external hard disk to the local hard disk
def copyFilesOver(labels, env, bef):
    for files in labels:
        asmPath = os.path.join(conf['script']['externalFiles'], files + ".asm")
        bytePath = os.path.join(conf['script']['externalFiles'], files + ".bytes")

        copyASMLocation = os.path.join(conf[env]['file_loc'], files + ".asm")
        copyByteLocation = os.path.join(conf[env]['file_loc'], files + ".bytes")

        befASMLocation = os.path.join(conf[bef]['file_loc'], files + ".asm")
        befByteLocation = os.path.join(conf[bef]['file_loc'], files + ".bytes")

        if os.path.exists(befASMLocation) and os.path.exists(befByteLocation):
            shutil.move(befASMLocation,copyASMLocation)
            shutil.move(befByteLocation,copyByteLocation)
        elif os.path.exists(copyASMLocation) and os.path.exists(copyByteLocation):
            pass
        else:
            shutil.copy(asmPath,copyASMLocation)
            shutil.copy(bytePath,copyByteLocation)

def main(env):
    classLabels = getClassLabels()
    fileCount = countOfFiles(classLabels)
    copyFileCount = copyNFiles(fileCount, int(env))
    trainLabels, testLabels = getTrainingFilesName(classLabels, copyFileCount)
    print ">Training Data Files: " + str(len(trainLabels))
    print ">Testing Data Files: " + str(len(testLabels))
    createLabelsCSV(classLabels, trainLabels, testLabels)
    print ">Training & Testing Labels Created."
    makeDataFolders()
    print ">Training & Testing Data Folder Created."
    copyFilesOver(trainLabels,'train','test')
    print ">Training Files Copied."
    copyFilesOver(testLabels,'test','train')
    print ">Testing Files Copied."

if __name__ == "__main__":
    sys.path.append("..")
    from config import conf
    main(sys.argv[1])
